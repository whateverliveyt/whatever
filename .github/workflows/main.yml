name: TEST â€“ Rotating Content Pool (DRY RUN SAFE)

on:
  workflow_dispatch:

jobs:
  test-run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg bc wget

      - name: Download videos (safe auto)
        run: |
          echo "Download ListA"
          for i in $(seq -w 1 50); do
            wget -q https://github.com/whateverliveyt/whatever/releases/download/v1.0/listA_${i}.mp4 || true
          done

          echo "Download ListB"
          for i in $(seq -w 1 50); do
            wget -q https://github.com/whateverliveyt/whatever/releases/download/v1.0/listB_${i}.mp4 || true
          done

          wget -q https://github.com/whateverliveyt/whatever/releases/download/v1.0/intro.mp4 || true

      - name: Init state
        run: |
          ls listA_*.mp4 2>/dev/null > active.txt
          ls listB_*.mp4 2>/dev/null > reserve.txt
          : > recycle.txt

          echo "ACTIVE:"
          cat active.txt || true
          echo "RESERVE:"
          cat reserve.txt || true

      - name: Dry run streaming
        run: |
          COUNT=$(wc -l < active.txt)

          if [ "$COUNT" -ge 15 ]; then
            MAX_LOOP=1
          elif [ "$COUNT" -ge 8 ]; then
            MAX_LOOP=2
          else
            MAX_LOOP=3
          fi

          echo "COUNT=$COUNT"
          echo "MAX_LOOP=$MAX_LOOP"

          LOOP=1
          while [ $LOOP -le $MAX_LOOP ]; do
            shuf active.txt > play_order.txt
            : > playlist.txt

            while read f; do
              echo "file '$PWD/$f'" >> playlist.txt
            done < play_order.txt

            ffmpeg -re -f concat -safe 0 -i playlist.txt -t 15 -f null -

            LOOP=$((LOOP+1))
          done

      - name: Rotation test
        run: |
          COUNT=$(wc -l < active.txt)
          if [ "$COUNT" -ge 12 ]; then N=2; else N=1; fi

          echo "ROTATION MODE: $N OUT / $N IN"
          shuf active.txt | head -n $N
          shuf reserve.txt | head -n $N
