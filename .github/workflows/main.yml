name: Live Streaming – Rotating Content Pool (Final Auto Duration)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 10 * * 1"
    - cron: "30 10 * * 2"
    - cron: "30 9 * * 3"
    - cron: "0 10 * * 4"
    - cron: "0 11 * * 5"
    - cron: "30 9 * * 6"
    - cron: "30 10 * * 0"

jobs:
  live-stream:
    runs-on: ubuntu-latest

    # FAILSAFE SAJA — BUKAN TARGET DURASI LIVE
    # SENGAJA BESAR AGAR VIDEO TIDAK PERNAH TERPOTONG
    timeout-minutes: 360

    steps:
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Download videos (tolerant)
        run: |
          for i in {01..20}; do
            wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/listA_$i.mp4 \
            || echo "listA_$i missing"
          done

          for i in {01..15}; do
            wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/listB_$i.mp4 \
            || echo "listB_$i missing"
          done

          wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/intro.mp4 \
          || echo "intro missing"

      - name: Init state files
        run: |
          ls listA_*.mp4 > active.txt
          ls listB_*.mp4 > reserve.txt
          : > recycle.txt

      - name: Play ACTIVE pool (Soft Loop max 2x, auto stop)
        env:
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          GAIN=$(awk 'BEGIN{srand(); print int(rand()*5)-2}')
          echo "Audio gain: ${GAIN}dB"

          LOOP=1
          MAX_LOOP=2

          while [ $LOOP -le $MAX_LOOP ]; do
            echo "=== PLAY LOOP $LOOP ==="

            shuf active.txt > play_order.txt
            : > playlist.txt

            # Intro hanya di awal live
            if [ -f intro.mp4 ] && [ $LOOP -eq 1 ]; then
              echo "file '$PWD/intro.mp4'" >> playlist.txt
            fi

            while read f; do
              echo "file '$PWD/$f'" >> playlist.txt
            done < play_order.txt

            # FFmpeg akan MENJALANKAN video SAMPAI HABIS
            # Live berhenti NATURAL saat playlist selesai
            ffmpeg -re -f concat -safe 0 -i playlist.txt \
              -filter:a "volume=${GAIN}dB" \
              -c:v libx264 -preset veryfast -maxrate 3000k -bufsize 6000k \
              -pix_fmt yuv420p -g 50 \
              -c:a aac -b:a 128k -ar 44100 \
              -f flv "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY"

            LOOP=$((LOOP+1))
          done

      - name: Rotate AFTER live (1 out / 1 in)
        run: |
          OUT=$(shuf active.txt | head -n 1)
          IN=$(shuf reserve.txt | head -n 1)

          echo "ROTATE OUT: $OUT"
          echo "ROTATE IN : $IN"

          grep -v "^$OUT$" active.txt > tmp && mv tmp active.txt
          echo "$OUT" >> recycle.txt

          grep -v "^$IN$" reserve.txt > tmp && mv tmp reserve.txt
          echo "$IN" >> active.txt

          if [ ! -s reserve.txt ]; then
            echo "Reserve empty → refill from recycle"
            cat recycle.txt > reserve.txt
            : > recycle.txt
          fi

          echo "=== ACTIVE FOR NEXT LIVE ==="
          cat active.txt
