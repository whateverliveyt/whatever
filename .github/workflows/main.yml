name: Live Streaming Final (Stable)

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "16 10 * * 1"   # aktifkan nanti kalau sudah yakin

jobs:
  live-stream:
    runs-on: ubuntu-latest
    timeout-minutes: 180   # 3 jam

    steps:
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Download video (toleran, anti error)
        run: |
          echo "Download listA"
          for i in {01..15}; do
            wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/listA_$i.mp4 \
            || echo "listA_$i.mp4 tidak ada"
          done

          echo "Download listB"
          for i in {01..10}; do
            wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/listB_$i.mp4 \
            || echo "listB_$i.mp4 tidak ada"
          done

          echo "Download intro (opsional)"
          wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/intro.mp4 \
          || echo "intro.mp4 tidak ada, lanjut tanpa intro"

      - name: Rotasi harian 2 keluar - 2 masuk (SAFE)
        run: |
          set +e

          A_ALL=$(ls listA_*.mp4 2>/dev/null)
          B_ALL=$(ls listB_*.mp4 2>/dev/null)

          if [ -z "$A_ALL" ] || [ -z "$B_ALL" ]; then
            echo "listA atau listB kosong, skip rotasi"
            exit 0
          fi

          KELUAR=$(echo "$A_ALL" | shuf -n 2)
          MASUK=$(echo "$B_ALL" | shuf -n 2)

          i=1
          for A in $KELUAR; do
            B=$(echo "$MASUK" | sed -n "${i}p")
            [ -z "$B" ] && continue

            mv "$A" "out_$i.mp4"
            mv "$B" "in_$i.mp4"

            mv "in_$i.mp4" "$A"
            mv "out_$i.mp4" "$B"

            i=$((i+1))
          done

          echo "ROTASI SELESAI"

      - name: Buat playlist (acak + intro opsional)
        run: |
          ls listA_*.mp4 | shuf > urutan.txt

          > playlist.txt

          if [ -f intro.mp4 ]; then
            echo "file '$PWD/intro.mp4'" >> playlist.txt
          fi

          while read f; do
            echo "file '$PWD/$f'" >> playlist.txt
          done < urutan.txt

          echo "=== PLAYLIST ==="
          cat playlist.txt

      - name: Mulai Streaming (loop + audio random ringan)
        env:
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          GAIN=$(shuf -i -2-2 -n 1)
          echo "Audio gain: ${GAIN}dB"

          ffmpeg -re -f concat -safe 0 -stream_loop -1 -i playlist.txt \
            -filter:a "volume=${GAIN}dB" \
            -c:v libx264 -preset veryfast -maxrate 3000k -bufsize 6000k \
            -pix_fmt yuv420p -g 50 \
            -c:a aac -b:a 128k -ar 44100 \
            -f flv "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY"
