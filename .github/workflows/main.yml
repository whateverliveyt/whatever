name: Live Streaming – Rotating Content Pool (Ultimate)

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "0 10 * * *"

jobs:
  live-stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # FAILSAFE SAJA

    steps:
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Download videos (tolerant)
        run: |
          for i in {01..20}; do
            wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/listA_$i.mp4 \
            || echo "listA_$i missing"
          done

          for i in {01..15}; do
            wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/listB_$i.mp4 \
            || echo "listB_$i missing"
          done

          wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/intro.mp4 \
          || echo "intro missing"

      # ===============================
      # LOAD STATE
      # ===============================
      - name: Load previous state
        uses: actions/download-artifact@v4
        with:
          name: content-state
        continue-on-error: true

      - name: Init state if missing
        run: |
          if [ ! -f active.txt ]; then
            ls listA_*.mp4 > active.txt
            ls listB_*.mp4 > reserve.txt
            : > recycle.txt
          fi

      # ===============================
      # HEALTH CHECK GUARD
      # ===============================
      - name: Health check
        env:
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          if [ -z "$STREAM_KEY" ]; then
            echo "STREAM_KEY missing → abort"
            exit 1
          fi

          if [ ! -s active.txt ]; then
            echo "ACTIVE list empty → abort"
            exit 1
          fi

      # ===============================
      # ADAPTIVE SOFT LOOP
      # ===============================
      - name: Play live (adaptive loop + micro variation)
        env:
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          COUNT=$(wc -l < active.txt)

          if [ "$COUNT" -lt 6 ]; then
            MAX_LOOP=3
          elif [ "$COUNT" -lt 12 ]; then
            MAX_LOOP=2
          else
            MAX_LOOP=1
          fi

          echo "Video count: $COUNT"
          echo "Max loop: $MAX_LOOP"

          GAIN=$(awk 'BEGIN{srand(); print int(rand()*5)-2}')
          BRIGHT=$(awk 'BEGIN{srand(); printf "%.2f", 1 + (rand()*0.02 - 0.01)}')
          SAT=$(awk 'BEGIN{srand(); printf "%.2f", 1 + (rand()*0.02 - 0.01)}')

          LOOP=1
          while [ $LOOP -le $MAX_LOOP ]; do
            shuf active.txt > play_order.txt
            : > playlist.txt

            if [ -f intro.mp4 ] && [ $LOOP -eq 1 ]; then
              echo "file '$PWD/intro.mp4'" >> playlist.txt
            fi

            while read f; do
              echo "file '$PWD/$f'" >> playlist.txt
            done < play_order.txt

            ffmpeg -re -f concat -safe 0 -i playlist.txt \
              -filter_complex "volume=${GAIN}dB,eq=brightness=$(echo "$BRIGHT-1" | bc):saturation=$SAT" \
              -c:v libx264 -preset veryfast -maxrate 3000k -bufsize 6000k \
              -pix_fmt yuv420p -g 50 \
              -c:a aac -b:a 128k -ar 44100 \
              -f flv "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY"

            LOOP=$((LOOP+1))
          done

      # ===============================
      # ROTATE & SAVE STATE
      # ===============================
      - name: Rotate & save state
        run: |
          OUT=$(shuf active.txt | head -n 1)
          IN=$(shuf reserve.txt | head -n 1)

          grep -v "^$OUT$" active.txt > tmp && mv tmp active.txt
          echo "$OUT" >> recycle.txt

          grep -v "^$IN$" reserve.txt > tmp && mv tmp reserve.txt
          echo "$IN" >> active.txt

          if [ ! -s reserve.txt ]; then
            cat recycle.txt > reserve.txt
            : > recycle.txt
          fi

      - name: Save state
        uses: actions/upload-artifact@v4
        with:
          name: content-state
          path: |
            active.txt
            reserve.txt
            recycle.txt
