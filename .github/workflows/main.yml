name: Live Streaming

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "0 10 * * *"

jobs:
  live-stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg bc

      - name: Download videos
        run: |
          for i in {01..20}; do
            wget -q https://github.com/whateverliveyt/whatever/releases/download/v1.0/listA_$i.mp4 || true
          done
          for i in {01..15}; do
            wget -q https://github.com/whateverliveyt/whatever/releases/download/v1.0/listB_$i.mp4 || true
          done
          wget -q https://github.com/whateverliveyt/whatever/releases/download/v1.0/intro.mp4 || true

      - name: Load previous state
        uses: actions/download-artifact@v4
        with:
          name: content-state
        continue-on-error: true

      - name: Init state if missing
        run: |
          if [ ! -f active.txt ]; then
            ls listA_*.mp4 > active.txt
            ls listB_*.mp4 > reserve.txt
            : > recycle.txt
          fi

      - name: Health check
        env:
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          [ -z "$STREAM_KEY" ] && exit 1
          [ ! -s active.txt ] && exit 1

      - name: Live streaming
        env:
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          COUNT=$(wc -l < active.txt)

          if [ "$COUNT" -lt 6 ]; then
            MAX_LOOP=3
          elif [ "$COUNT" -lt 12 ]; then
            MAX_LOOP=2
          else
            MAX_LOOP=1
          fi

          GAIN=$(awk 'BEGIN{srand(); print int(rand()*5)-2}')
          BRIGHT=$(awk 'BEGIN{srand(); printf "%.3f", (rand()*0.02 - 0.01)}')
          SAT=$(awk 'BEGIN{srand(); printf "%.3f", 1 + (rand()*0.02 - 0.01)}')

          LOOP=1
          while [ $LOOP -le $MAX_LOOP ]; do
            shuf active.txt > play_order.txt
            : > playlist.txt

            if [ -f intro.mp4 ] && [ $LOOP -eq 1 ]; then
              echo "file '$PWD/intro.mp4'" >> playlist.txt
            fi

            while read f; do
              echo "file '$PWD/$f'" >> playlist.txt
            done < play_order.txt

            ffmpeg -re -f concat -safe 0 -i playlist.txt \
              -filter:a "volume=${GAIN}dB" \
              -filter:v "eq=brightness=${BRIGHT}:saturation=${SAT}" \
              -c:v libx264 -preset veryfast -maxrate 3000k -bufsize 6000k \
              -pix_fmt yuv420p -g 50 \
              -c:a aac -b:a 128k -ar 44100 \
              -f flv "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY"

            LOOP=$((LOOP+1))
          done

      - name: Rotate content (2 out / 2 in)
        run: |
          OUTS=$(shuf active.txt | head -n 2)
          INS=$(shuf reserve.txt | head -n 2)

          for O in $OUTS; do
            grep -v "^$O$" active.txt > tmp && mv tmp active.txt
            echo "$O" >> recycle.txt
          done

          for I in $INS; do
            grep -v "^$I$" reserve.txt > tmp && mv tmp reserve.txt
            echo "$I" >> active.txt
          done

          if [ $(wc -l < reserve.txt) -lt 2 ]; then
            cat recycle.txt >> reserve.txt
            : > recycle.txt
          fi

      - name: Save state
        uses: actions/upload-artifact@v4
        with:
          name: content-state
          path: |
            active.txt
            reserve.txt
            recycle.txt
